// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  
  email     String   @unique
  password  String   // bcrypt hashed
  firstName String
  lastName  String
  role      UserRole @default(OPERATOR) // Keep for backward compatibility during migration
  archetypeId Int?   // New archetype-based role system
  tenantId  Int?     // For multi-tenancy - references the tenant owner User.id
  isActive  Boolean  @default(true)
  
  // Relations
  projects      Project[]
  activityLogs  ActivityLog[]
  notifications Notification[]
  archetype     RoleArchetype?      @relation(fields: [archetypeId], references: [id])
  tenant        User?               @relation("TenantUsers", fields: [tenantId], references: [id])
  tenantUsers   User[]              @relation("TenantUsers")
  roleMappings  TenantRoleMapping[] @relation("TenantRoleMappings")

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
}

model RoleArchetype {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  
  code         String   @unique // e.g., "ADMIN", "MANAGER", "OPERATOR", "INSPECTOR"
  defaultLabel String   // e.g., "Administrator", "Manager", "Operator", "Inspector"
  description  String   // Detailed description of the role
  isActive     Boolean  @default(true)
  
  // Relations
  tenantMappings TenantRoleMapping[]
  users          User[]
  
  @@map("role_archetypes")
}

model TenantRoleMapping {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  
  tenantId     Int      // References User.id (tenant owner)
  archetypeId  Int
  customLabel  String?  // Custom label for this archetype in this tenant
  icon         String?  // Icon identifier
  color        String?  // Color hex code
  isEnabled    Boolean  @default(true)
  
  // Relations
  tenant       User         @relation("TenantRoleMappings", fields: [tenantId], references: [id])
  archetype    RoleArchetype @relation(fields: [archetypeId], references: [id])
  
  @@unique([tenantId, archetypeId])
  @@map("tenant_role_mappings")
}

model Project {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  
  name        String
  description String?
  status      ProjectStatus @default(DRAFT)
  
  // Relations
  userId         Int
  user           User                 @relation(fields: [userId], references: [id])
  codes          OptropicCode[]
  keys           Key[]
  contents       Content[]
  assets         Asset[]
  configPacks    TenantConfigPack[]
  analyticsCache AnalyticsCache[]

  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

model OptropicCode {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  codeValue       String          @unique
  codeType        CodeType
  encryptionLevel EncryptionLevel @default(AES_128)
  entropySeed     String
  signature       String
  payload         Json
  isActive        Boolean         @default(true)

  // GS1 Digital Link support
  gs1DigitalLink String?

  // Relations
  projectId Int
  project   Project @relation(fields: [projectId], references: [id])
  keyId     Int?
  key       Key?    @relation(fields: [keyId], references: [id])
  assetId   Int?
  asset     Asset?  @relation(fields: [assetId], references: [id])
  scans     Scan[]

  @@map("optropic_codes")
}

enum CodeType {
  OPTROPIC
  QRSSL
  GS1_COMPLIANT
}

enum EncryptionLevel {
  AES_128
  AES_256
  RSA_2048
  RSA_4096
}

model Key {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  keyName              String
  keyType              KeyType
  publicKey            String?
  encryptedPrivateKey  String
  algorithm            String   @default("prime256v1")
  isActive             Boolean  @default(true)
  expiresAt            DateTime?

  // Key pairing for dual verification
  pairedKeyId Int?
  pairedKey   Key?  @relation("KeyPairing", fields: [pairedKeyId], references: [id])
  pairedWith  Key[] @relation("KeyPairing")

  // Relations
  projectId Int
  project   Project        @relation(fields: [projectId], references: [id])
  codes     OptropicCode[]

  @@map("keys")
}

enum KeyType {
  ENCRYPTION
  SIGNING
  NFC_PAIRING
  RFID_PAIRING
}

model Content {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  title         String
  contentType   ContentType
  url           String?
  fileUrl       String?
  fileSize      Int?
  mimeType      String?
  version       Int         @default(1)
  downloadCount Int         @default(0)
  isActive      Boolean     @default(true)

  // Dynamic redirect logic
  redirectRules Json?

  // Relations
  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  @@map("contents")
}

enum ContentType {
  URL_REDIRECT
  LANDING_PAGE
  PDF_DOCUMENT
  IMAGE
  VIDEO
  CAMPAIGN
}

model Asset {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  
  assetName    String
  serialNumber String?
  batchNumber  String?
  productId    String?
  assetType    AssetType
  
  // Relations
  projectId Int
  project   Project        @relation(fields: [projectId], references: [id])
  codes     OptropicCode[]
  
  @@map("assets")
}

enum AssetType {
  PRODUCT
  PACKAGE
  BATCH
  EQUIPMENT
  DOCUMENT
}

model Scan {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // Scan details
  ipAddress   String?
  userAgent   String?
  deviceType  DeviceType?
  region      String?
  country     String?
  city        String?
  geoHash     String?

  // Verification
  verificationSuccess Boolean @default(false)
  trustScore          Int?
  failureReason       String?

  // Security flags
  isSuspicious Boolean @default(false)
  riskScore    Float?

  // Relations
  codeId Int
  code   OptropicCode @relation(fields: [codeId], references: [id])

  @@map("scans")
}

enum DeviceType {
  MOBILE
  DESKTOP
  TABLET
  IOT_DEVICE
  SCANNER
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  
  action      String
  entityType  String
  entityId    Int?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  
  // Relations
  userId Int
  user   User @relation(fields: [userId], references: [id])
  
  @@map("activity_logs")
}

model TenantConfigPack {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  name        String
  description String?
  useCase     UseCase
  roles       String[]
  actions     Json
  productList Json
  configJson  Json
  isActive    Boolean  @default(true)

  // Relations
  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id])

  @@map("tenant_config_packs")
}

enum UseCase {
  AUTHENTICATION
  MAINTENANCE
  COMPLIANCE
  ENGAGEMENT
}

model Notification {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  userId   Int
  type     String
  title    String
  message  String
  metadata Json?
  link     String?
  isRead   Boolean @default(false)

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model AnalyticsCache {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  projectId Int
  cacheKey  String
  data      Json
  expiresAt DateTime

  project Project @relation(fields: [projectId], references: [id])

  @@unique([projectId, cacheKey])
  @@map("analytics_cache")
}
